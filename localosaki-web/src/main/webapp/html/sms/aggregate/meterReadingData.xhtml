<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:cust="http://xmlns.jcp.org/jsf/component"
    xmlns:oslib="http://osaki.co.jp/base-component"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:jsf="http://xmlns.jcp.org/jsf"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions">
<h:body>
  <ui:composition template="/html/template/template_aggregate_sidemenu.xhtml">
    <ui:define name="content_side" class="content">
      <h:outputStylesheet library="css" name="common/cssLayout.css" />
      <h:outputStylesheet library="css" name="common/button.css" />
      <h:outputStylesheet library="css" name="common/rfCalendar.css" />
      <h:outputStylesheet library="css" name="sms/aggregate/meterReadingData.css" />

      <form jsfc="h:form" id="smsAggregateMeterReadingDataBean">
        <div class="inner_content">
          <div class="title_area_warp">
            <!-- 画面タイトル -->
            <div class="title_area_left">
              <h2 class="page_title">検針データ</h2>
              <!-- ヘルプボタン -->
              <c:if test="#{indexBean.userGuideBool}">
                <h:commandLink class="help_icon" action="#{indexBean.userGuide()}" target="_blank" />
              </c:if>
            </div>
          </div>
          <div class="clear" />
          <!-- メッセージ表示部分 -->
          <rich:messages id="Messages" showSummary="true" />
          <!-- 説明文 -->
          <div class="search_description">
            <p>複数建物の検針データが一括でダウンロードできます。期間指定してダウンロードしてください。</p>
          </div>

          <!-- 出力条件指定 -->
          <div class="contents_title">
            <span class="contents_title_body">出力条件指定</span>
            <h:graphicImage library="images" name="common/com001.png" rendered="true" />
          </div>

          <div class="contents_form_area">
            <div class="conditions">
              <div class="condition_row">
                <label class="TXT008 L1">検針日時</label>
                <div class="condition_contents">
                  <h:inputText id="calStartText" class="check_change autofocus"
                    value="#{smsAggregateMeterReadingDataBean.startDate}" maxlength="10"
                    style="#{smsAggregateDailyBean.getInvalidStyle(component.clientId)}">
                    <f:ajax event="change" render="idCalStart" />
                    <f:passThroughAttribute name="placeholder" value="YYYY/MM/DD" />
                  </h:inputText>
                  <div class="btnCal">
                    <rich:calendar id="idCalStart" class="calDayDaily" datePattern="yyyy/MM/dd"
                      enableManualInput="false" showWeeksBar="false" showFooter="false"
                      required="false" showInput="false"
                      buttonIcon="#{request.contextPath}/resources/images/common/com030.png"
                      zindex="50" styleClass="calobj" value="#{smsAggregateMeterReadingDataBean.calStartDate}">
                      <f:ajax event="change" render="calStartText" />
                    </rich:calendar>
                  </div>
                  <h:outputText value="～" styleClass="date_sep" />
                  <h:inputText id="calEndText" class="check_change autofocus"
                    value="#{smsAggregateMeterReadingDataBean.endDate}" maxlength="10"
                    style="#{smsAggregateDailyBean.getInvalidStyle(component.clientId)}">
                    <f:ajax event="change" render="idCalEnd" />
                    <f:passThroughAttribute name="placeholder" value="YYYY/MM/DD" />
                  </h:inputText>
                  <div class="btnCal">
                    <rich:calendar id="idCalEnd" class="calDayDaily" datePattern="yyyy/MM/dd"
                      enableManualInput="false" showWeeksBar="false" showFooter="false"
                      required="false" showInput="false"
                      buttonIcon="#{request.contextPath}/resources/images/common/com030.png"
                      zindex="50" styleClass="calobj" value="#{smsAggregateMeterReadingDataBean.calEndDate}">
                      <f:ajax event="change" render="calEndText" />
                    </rich:calendar>
                  </div>
                  <div id="spanMessage">
                    <span style="color: red">※指定した期間に応じてダウンロード待ち時間が長くなります。</span>
                  </div>
                </div>
              </div>
              <div class="condition_row_flex">
                <label class="TXT008 L1">検針種別</label>
                <div class="condition_contents">
                  <div jsfc="h:selectOneRadio" value="#{smsAggregateMeterReadingDataBean.inspType}"
                    class="dispType">
                    <option jsfc="f:selectItems" value="#{smsAggregateMeterReadingDataBean.inspTypeMap}" />
                  </div>
                </div>
              </div>
              <div class="condition_row_flex">
                <label class="TXT008 L1">最大デマンド値</label>
                <div class="condition_contents_flex">
                  <div class="th-sep-label">
                    <h:selectBooleanCheckbox
                      id="outputMaxDemand"
                      value="#{smsAggregateMeterReadingDataBean.outputMaxDemand}" />
                    出力する
                  </div>
                </div>
              </div>
              <div class="condition_row_flex">
              	<div class="TXT008 L1">
              		<label >前年同月検針値</label>
              		<label class="L2"><br />(検針日時・使用量)</label>
              	</div>
                <div class="condition_contents_flex_2">
                  <div class="th-sep-label">
                    <h:selectBooleanCheckbox
                      id="outputPrivYearAndSameMonth"
                      value="#{smsAggregateMeterReadingDataBean.outputPrivYearAndSameMonth}" />
                    出力する
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 説明文 -->
          <div class="search_description">
            <p>検索条件を設定して[検索開始]を押してください。</p>
          </div>

          <!-- 動的検索条件テーブル -->
          <div class="gradation_type_1">
            <a4j:outputPanel id="commonSearchResult">
              <rich:dataTable id="searchConditionTable" rows="0"
                value="#{smsAggregateMeterReadingDataBean.conditionList}" var="item"
                style="margin-top: 5px;
                       width: 100%;
                       border: 0px;
                       table-layout: fixed;">
                <!--検索条件表示部分 -->
                <span jsfc="h:column" styleClass="condition_msg" style="width: 20%; border: 0px">
                  <h:selectOneMenu id="selectConditionCd" value="#{item.selectConditionCd}"
                    styleClass="SELECT001" rendered="#{item.selectEnable}" style="height: 30px;">
                    <f:ajax event="change" execute="smsAggregateMeterReadingDataBean:searchConditionTable"
                      render="smsAggregateMeterReadingDataBean:searchConditionTable"
                      listener="#{smsAggregateMeterReadingDataBean.changeConditionCd(item.orderNo)}"
                      onevent="autoFocusOnSelectCondition" />
                    <option jsfc="f:selectItems" value="#{item.selectConditionMap}" />
                  </h:selectOneMenu>
                  <h:outputText value="#{item.selectConditionCd}" rendered="#{item.selectDisable}" />
                </span>
                <!--接続詞表示部分 -->
                <span jsfc="h:column" style="width: 10%; text-align: center; border: 0px;">
                  <input jsfc="h:outputText" value="#{item.searchSubjectConjunction}"
                    style="width: 100%; text-align: center"
                    rendered="#{item.searchSubjectConjunctionEnable}" />
                </span>
                <!--ドロップダウンリストまたは検索キーワード表示部分 -->
                <span jsfc="h:column" style="width: 40%; border: 0px;">
                  <!-- 都道府県-->
                  <h:selectOneMenu id="prefectureCd" value="#{item.prefectureCd}"
                    styleClass="SELECT001" rendered="#{item.prefectureSelectEnable}"
                    style="width: 100%; height: 25px;" onkeydown="searchConditionKeydown()">
                    <option jsfc="f:selectItems" value="#{smsAggregateMeterReadingDataBean.prefectureMap}" />
                  </h:selectOneMenu>
                  <!--キーワード -->
                  <h:inputText id="conditionKeyword" value="#{item.conditionKeyword}"
                    styleClass="EDIT002" class="autofocus" rendered="#{item.keywordSelectEnable}"
                    style="width: 100%; height: 25px;" maxlength="50"
                    onkeydown="searchConditionKeydown()" />
                </span>
                <!--「を含む」表示部分 -->
                <span jsfc="h:column" style="width: 12%; text-align: center; border: 0px;">
                  <input jsfc="h:outputText" value="#{item.mutchingTypeCd}"
                    rendered="${!empty item.mutchingTypeCd}"
                    style="width: 100%; height: 25px; text-align: center;" />
                </span>
                <!--削除ボタン表示部分 -->
                <span jsfc="h:column" styleClass="gradation_type_3 button_medium_2 delete_button"
                  style="width: 10%; border: 0px;">
                  <h:commandButton id="delButton" value="削除" rendered="#{item.deleteButtonEnable}"
                    style="width: 100%; height: 25px;">
                    <f:ajax event="click" execute="smsAggregateMeterReadingDataBean:searchConditionTable"
                      render="smsAggregateMeterReadingDataBean:searchConditionTable"
                      listener="#{smsAggregateMeterReadingDataBean.deleteCondition(item.orderNo)}" />
                  </h:commandButton>
                  <h:graphicImage class="button_icon" library="images"
                    rendered="#{item.deleteButtonEnable}" name="common/com020.png" />
                </span>
              </rich:dataTable>
            </a4j:outputPanel>
          </div>

          <!-- 検索ボタン -->
          <div class="button_area_center gradation_type_1 button_large_2 button_search">
            <input id="searchButton" class="action_button" jsfc="h:commandButton" value="検索開始">
              <a4j:ajax event="click" execute="@form" render="@form"
                listener="#{smsAggregateMeterReadingDataBean.search()}" onbegin="showBlockModal()"
                oncomplete="hideBlockModal()" /> </input>
            <h:graphicImage class="button_icon" library="images" name="common/com028.png" />
          </div>

          <div class="contents_header" jsf:id="button">
              <span
                  class="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.searchResultStyle}">
                  <a4j:commandButton id="searchResultDisplayButton" value="検索結果"
                      class="button_large_2 btn_icon_input" execute="@form"
                      render="button search_result_display_area reservation_status_display_area"
                      actionListener="#{smsAggregateMeterReadingDataBean.searchResultDisplay()}"
                      disabled="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.searchResultDisabled}"
                      onbegin="showBlockModal()"
                      oncomplete="hideBlockModal()">
                      <h:graphicImage class="button_search_result" library="images"
                          name="sms/collect/dataview/btn_list.png" />
                  </a4j:commandButton>
              </span> <span
                  class="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.reservationStatusStyle}">
                  <a4j:commandButton id="reservationStatusDisplayButton" value="予約状況"
                      class="button_large_2 btn_icon_input" execute="@form"
                      render="button search_result_display_area reservation_status_display_area"
                      actionListener="#{smsAggregateMeterReadingDataBean.reservationStatusDisplay()}"
                      disabled="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.reservationStatusDisabled}"
                      onbegin="showBlockModal()"
                      oncomplete="hideBlockModal()">
                      <h:graphicImage class="button_async_status"
                          library="images"
                          name="sms/collect/dataview/btn_status.png" />
                  </a4j:commandButton>
              </span>
          </div>

          <div jsf:id="search_result_display_area">

            <!-- 検索結果表示 -->
            <!-- ダウンロードボタン -->
            <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.pagingList.resultCount != '0'}">
              <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.searchedFlg}">
                <div class="contents_right gradation_type_1 button_large_2 button_download">
                    <a4j:commandButton 
                        id="downloadButton" 
                        value="ダウンロード予約"
                        execute="@form"
                        render="@form"
                        onbegin="showBlockModal()"
                        onclick="return confirmationDialogOpen($('input[id$=downloadButton]'));"
                        actionListener="#{smsAggregateMeterReadingDataBean.countIncompleteReservation()}"
                        oncomplete="hideBlockModal(); if($('.rf-msgs-err').size()==0) $('input[id$=meterReadingDataDownload]').click();">
                    </a4j:commandButton>
                    <h:graphicImage class="dl_button_icon" library="images" name="common/com044.png" />
                    
                   
                  
                </div>
              </ui:fragment>
            </ui:fragment>

            <!-- 検索結果サマリー表示 -->
            <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.searchedFlg}">
              <div class="search_result_header_wrap">
                <div id="listReroad">
                  <div class="search_result_header_left page_content_parts">
                    検索条件に該当する検針情報
                    <span class="serach_result_total_count" jsfc="h:outputText"
                      value=" #{smsAggregateMeterReadingDataBean.pagingList.resultCount}" />
                    件
                  </div>
                </div>
              </div>
              <!-- 検索結果リスト表示 -->
              <div class="search_result_area">
                <h:dataTable id="search_result" var="item" style="width: 100%;"
                  value="#{smsAggregateMeterReadingDataBean.pagingList.pageList}" headerClass="table_header"
                  columnClasses="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.columnClassesStr}"
                  rendered="#{smsAggregateMeterReadingDataBean.pagingList.resultCount != '0'}">

                  <!-- 企業 -->
                  <span jsfc="h:column"
                    rendered="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.viewCorpIdAndName}">
                    <f:facet name="header">企業ID<br />企業名</f:facet>
                    <h:panelGrid columns="1">
                      <h:outputText id="corpId" value="#{item.corpId}" />
                      <h:outputText id="corpName" value="#{item.corpName}" />
                    </h:panelGrid>
                  </span>
                  <!-- 建物 or テナントアイコン -->
                  <span jsfc="h:column">
                    <f:facet name="header">
                    </f:facet>
                    <h:graphicImage class="button_icon" library="images" name="common/com074.png"
                      rendered="#{item.tenantFlg}" />
                    <h:graphicImage class="button_icon" library="images" name="common/com075.png"
                      rendered="#{!item.tenantFlg}" />
                  </span>
                  <!-- 建物 -->
                  <span jsfc="h:column">
                    <f:facet name="header">建物番号<br />建物名</f:facet>
                    <h:panelGrid columns="1">
                      <h:outputText id="buildingNo" value="#{item.buildingNo}" />
                      <h:outputText id="buildingName" value="#{item.buildingName}" />
                    </h:panelGrid>
                  </span>
                  <!-- 検針日時 -->
                  <span jsfc="h:column">
                    <f:facet name="header">検針日時</f:facet>
                    <h:outputText id="meterReadingDate" value="#{item.meterReadingDate}" />
                  </span>
                  <!-- 検針連番 -->
                  <span jsfc="h:column">
                    <f:facet name="header">検針連番</f:facet>
                    <h:outputText id="meterReadingSerialNumber" value="#{item.meterReadingSerialNumber}" />
                  </span>
                  <!-- 検針種別 -->
                  <span jsfc="h:column">
                    <f:facet name="header">検針種別</f:facet>
                    <h:outputText id="inspTypeName" value="#{item.inspTypeName}" />
                  </span>
                </h:dataTable>
              </div>

              <!-- ページング -->
              <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.pagingList.resultCount != '0'}">
                <div class="contents_center">
                  <div id="paging_area">
                    <span id="prevButton_area">
                      <h:commandLink id="prevButton" value="&lt;&nbsp;&nbsp;前へ"
                        actionListener="#{smsAggregateMeterReadingDataBean.prevPage}"
                        disabled="#{!smsAggregateMeterReadingDataBean.pagingList.isPrevPage()}">
                        <f:ajax execute="@form" render="@form" />
                        <f:attribute name="page"
                          value="#{smsAggregateMeterReadingDataBean.pagingList.currentPage}" />
                      </h:commandLink>
                    </span>
                    <cust:pageIndex id="pageJumpButton"
                      value="#{smsAggregateMeterReadingDataBean.pagingList.pageValue}"
                      action="#{smsAggregateMeterReadingDataBean.pageJump()}">
                      <ui:include src="/html/common/paging/index.xhtml" />
                    </cust:pageIndex>
                    <span id="nextButton_area">
                      <h:commandLink id="nextButton" class="nextButton" value="後へ&nbsp;&nbsp;&gt; "
                        actionListener="#{smsAggregateMeterReadingDataBean.nextPage}"
                        disabled="#{!smsAggregateMeterReadingDataBean.pagingList.isNextPage()}">
                        <f:ajax execute="@form" render="@form" />
                        <f:attribute name="page"
                          value="#{smsAggregateMeterReadingDataBean.pagingList.currentPage}" />
                      </h:commandLink>
                    </span>
                  </div>
                </div>
              </ui:fragment>
            </ui:fragment>
          </div>

          <div jsf:id="reservation_status_display_area">

            <!-- 予約状況表示 -->
            <!-- 表示更新ボタン -->
            <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.statusPagingList.resultCount != '0'}">
            <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.reservationStatusFlg}">
                <div class="contents_right gradation_type_1 button_large_2 button_download">
                    <input id="reloadButton" class="action_button" jsfc="h:commandButton" value="表示更新">
                        <a4j:ajax event="click" execute="@form" render="@form"
                                  listener="#{smsAggregateMeterReadingDataBean.statusReload()}"
                                  onbegin="showBlockModal()"
                                  oncomplete="hideBlockModal()"/>
                    </input>
                    <h:graphicImage class="dl_button_icon" library="images" name="common/com015.png" />
                </div>
            </ui:fragment>
            </ui:fragment>

            <!-- 予約状況サマリー表示 -->
            <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.meterReadingDataBeanProperty.reservationStatusFlg}">
                <div class="status_header_wrap search_result_header_wrap">
                    <div id="listReroad">
                        <div class="search_result_header_left page_content_parts">
                            予約ダウンロード 最新
                            <span class="serach_result_total_count" jsfc="h:outputText"
                                  value=" #{smsAggregateMeterReadingDataBean.statusPagingList.resultCount}" />
                            件
                        </div>
                    </div>
                </div>
            <!-- 予約状況リスト表示 -->
            <div class="search_result_area">
              <c:set id="reservation_status" style="width: 100%;" var="items" value="#{smsAggregateMeterReadingDataBean.statusPagingList.pageList}" captionClass="caption"  headerClass="table_header"/>
              <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.statusPagingList.resultCount != '0'}">            
                <div class="search_result_area search_result reservation_content">
                  <table style="width: 100%;">
                      
                    <thead class="table_header">
                      <tr>
                        <th rowspan="2" class="request_date">リクエスト日時</th>
                        <th colspan="3" class="output_condition">出力条件</th>
                        <th rowspan="2" class="download_button_area">ダウンロード</th>
                      </tr>
                      <tr>
                        <th id="head21">対象</th>
                        <th id="head22" class="max_demand equal-width">最大ﾃﾞﾏﾝﾄﾞ値</th>
                       <th id="head23" class="priv_year_data equal-width">前年同月値</th>
                      </tr>
                    </thead>
                      
                    <tbody>
                      <c:forEach var="item" items="${items}">
                        <tr>
                          <td id="requestDate" class="column_style_process_serach_condition">
                              <h:outputText id="reservationDate" value="#{item.reservationDate}"/>
                          </td>
                          <td id="condition2" class="column_style_process_serach_condition">
                            <h:panelGrid columns="1">
                              <h:outputText id="insp_info" value="#{item.searchDate}の#{item.inspTypeName}検針データ" />
                              <h:outputText id="corp_param" value="#{item.corpParam}" />
                              <h:outputText id="building_Param" value="#{item.buildingParam}" />
                            </h:panelGrid>
                          </td>
                          <td id="creationCondition22" class="column_style_reservation_date" headers="head22">
                            <h:outputText id="max_demand" value="#{item.maxDemand}" />
                          </td>
                          <td id="creationCondition21" class="column_style_reservation_date" headers="head23">
                            <h:outputText id="priv_year_data" value="#{item.prevYearData}"/>
                          </td>
                          <td>
                            <ui:fragment rendered="#{!item.flg}">
                              <h:outputText id="status" value="処理中" />
                            </ui:fragment>
                            <ui:fragment rendered="#{item.flg}">
                              <div class="gradation_type_1 button_small async_download_button">
                                <h:commandButton id="asyncFileDownload"
                                                 action="#{smsAggregateMeterReadingDataBean.download(item.reservationId)}" />
                                <h:graphicImage class="async_download_button_icon" library="images" name="common/com040.png" />
                              </div>
                            </ui:fragment>
                          </td>
                        </tr>
                      </c:forEach>
                    </tbody>
                  </table>
                </div> 
              </ui:fragment>
            </div>


            <script type="text/javascript">
            var DIALOG_MSG = "#{smsAggregateMeterReadingDataBean.getBeforeReservationMessage(1)}";

            $(window).on("load", function() {
                // 画面表示時の処理
                ctrlBtnDisabled();
            });

            /*
             * 確認ダイアログ表示(登録)
             * @param btn 押下時したボタン
             */
            function confirmationDialogOpenForRsv(btn) {
                $('span[id$=confirmationDialogMessage]').html(DIALOG_MSG);
                return confirmationDialogOpen(btn);
            }

            </script>

              <!-- ページング -->
              <ui:fragment rendered="#{smsAggregateMeterReadingDataBean.statusPagingList.resultCount != '0'}">
                <div class="contents_center">
                  <div id="reserve_status_paging_area">
                    <span id="prevButton_area">
                      <h:commandLink id="prevStatusButton" value="&lt;&nbsp;&nbsp;前へ"
                        actionListener="#{smsAggregateMeterReadingDataBean.prevStatusPage}"
                        disabled="#{!smsAggregateMeterReadingDataBean.statusPagingList.isPrevPage()}">
                        <f:ajax execute="@form" render="@form" />
                        <f:attribute name="statusPage"
                          value="#{smsAggregateMeterReadingDataBean.statusPagingList.currentPage}" />
                      </h:commandLink>
                    </span>
                    <cust:pageIndex id="statusPageJumpButton"
                      value="#{smsAggregateMeterReadingDataBean.statusPagingList.pageValue}"
                      action="#{smsAggregateMeterReadingDataBean.statusPageJump()}">
                      <ui:include src="./index.xhtml" />
                    </cust:pageIndex>
                    <span id="nextButton_area">
                      <h:commandLink id="nextStatusButton" class="nextButton" value="後へ&nbsp;&nbsp;&gt; "
                        actionListener="#{smsAggregateMeterReadingDataBean.nextStatusPage}"
                        disabled="#{!smsAggregateMeterReadingDataBean.statusPagingList.isNextPage()}">
                        <f:ajax execute="@form" render="@form" />
                        <f:attribute name="statusPage"
                          value="#{smsAggregateMeterReadingDataBean.statusPagingList.currentPage}" />
                      </h:commandLink>
                    </span>
                  </div>
                </div>
              </ui:fragment>
            </ui:fragment>
          </div>
          <!-- ダウンロードボタン -->
                <button jsfc="h:commandButton" id="meterReadingDataDownload" style="display: none;"
                    action="#{smsAggregateMeterReadingDataBean.reservationStart()}">
                </button>

        </div>
        <ui:include src="/html/common/confirmationDialog.xhtml" >
                        <ui:param name="confirmationDialogTitle" value="確認" />
                        <ui:param name="confirmationDialogMessage" value="#{smsAggregateMeterReadingDataBean.getBeforeReservationMessage(1)}"/>
                    </ui:include>
      </form>
    </ui:define>
  </ui:composition>
</h:body>
</html>
